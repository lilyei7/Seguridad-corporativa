<!-- Componente de notificaciones tipo campana -->
<div class="relative" id="notifications-dropdown">
    <!-- Botón de notificaciones -->
    <button id="notifications-btn" class="relative p-2 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zm-8-13a6 6 0 016 6c0 2-3 6-3 6s-3-4-3-6a6 6 0 016-6z"></path>
        </svg>
        
        <!-- Badge de contador -->
        <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">
            0
        </span>
    </button>
    
    <!-- Dropdown de notificaciones -->
    <div id="notifications-menu" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Notificaciones</h3>
                <button id="mark-all-read-btn" class="text-sm text-blue-600 hover:text-blue-800">
                    Marcar todas como leídas
                </button>
            </div>
        </div>
        
        <!-- Lista de notificaciones -->
        <div id="notifications-list" class="max-h-96 overflow-y-auto">
            <!-- Las notificaciones se cargarán dinámicamente -->
            <div class="p-4 text-center text-gray-500">
                <i class="fas fa-bell-slash text-2xl mb-2"></i>
                <p>No hay notificaciones</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="px-4 py-3 border-t border-gray-200">
            <a href="{% url 'accounts:notifications' %}" class="block text-center text-blue-600 hover:text-blue-800 font-medium">
                Ver todas las notificaciones
            </a>
        </div>
    </div>
</div>

<!-- Estilos CSS específicos -->
<style>
.notification-item {
    transition: all 0.3s ease;
}

.notification-item:hover {
    background-color: #f8fafc;
}

.notification-unread {
    background-color: #eff6ff;
    border-left: 4px solid #3b82f6;
}

.notification-read {
    background-color: #ffffff;
    border-left: 4px solid #e5e7eb;
}

.notification-priority-urgent {
    border-left-color: #ef4444 !important;
}

.notification-priority-high {
    border-left-color: #f97316 !important;
}

.notification-priority-medium {
    border-left-color: #3b82f6 !important;
}

.notification-priority-low {
    border-left-color: #10b981 !important;
}

#notification-count {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.notification-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.notification-maintenance {
    background-color: #f59e0b;
    color: white;
}

.notification-incident {
    background-color: #ef4444;
    color: white;
}

.notification-visit {
    background-color: #10b981;
    color: white;
}

.notification-system {
    background-color: #3b82f6;
    color: white;
}

.notification-general {
    background-color: #6b7280;
    color: white;
}
</style>

<!-- JavaScript para funcionalidad de notificaciones -->
<script>
class NotificationManager {
    constructor() {
        this.isOpen = false;
        this.notifications = [];
        this.unreadCount = 0;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadNotifications();
        this.startPolling();
    }
    
    bindEvents() {
        const btn = document.getElementById('notifications-btn');
        const menu = document.getElementById('notifications-menu');
        const markAllBtn = document.getElementById('mark-all-read-btn');
        
        // Toggle dropdown
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleDropdown();
        });
        
        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                this.closeDropdown();
            }
        });
        
        // Marcar todas como leídas
        markAllBtn.addEventListener('click', () => {
            this.markAllAsRead();
        });
    }
    
    toggleDropdown() {
        const menu = document.getElementById('notifications-menu');
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            menu.classList.remove('hidden');
            this.loadNotifications();
        } else {
            menu.classList.add('hidden');
        }
    }
    
    closeDropdown() {
        const menu = document.getElementById('notifications-menu');
        menu.classList.add('hidden');
        this.isOpen = false;
    }
    
    async loadNotifications() {
        try {
            const response = await fetch('/api/notifications/');
            const data = await response.json();
            
            this.notifications = data.notifications;
            this.unreadCount = data.unread_count;
            
            this.updateUI();
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }
    
    updateUI() {
        this.updateCounter();
        this.renderNotifications();
    }
    
    updateCounter() {
        const counter = document.getElementById('notification-count');
        
        if (this.unreadCount > 0) {
            counter.textContent = this.unreadCount > 99 ? '99+' : this.unreadCount;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }
    
    renderNotifications() {
        const container = document.getElementById('notifications-list');
        
        if (this.notifications.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                    <p>No hay notificaciones</p>
                </div>
            `;
            return;
        }
        
        const html = this.notifications.map(notification => 
            this.renderNotificationItem(notification)
        ).join('');
        
        container.innerHTML = html;
        
        // Bind click events
        container.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                this.markAsRead(id);
            });
        });
    }
    
    renderNotificationItem(notification) {
        const isUnread = !notification.is_read;
        const readClass = isUnread ? 'notification-unread' : 'notification-read';
        const priorityClass = `notification-priority-${notification.priority}`;
        
        const iconMap = {
            'maintenance_request': 'fas fa-tools notification-maintenance',
            'incident_report': 'fas fa-exclamation-triangle notification-incident',
            'visit_notification': 'fas fa-user-friends notification-visit',
            'system_alert': 'fas fa-cog notification-system',
            'general': 'fas fa-bell notification-general'
        };
        
        const iconClass = iconMap[notification.notification_type] || iconMap['general'];
        
        return `
            <div class="notification-item ${readClass} ${priorityClass} p-4 border-b border-gray-100 cursor-pointer" 
                 data-id="${notification.id}">
                <div class="flex items-start space-x-3">
                    <div class="notification-icon ${iconClass.split(' ').slice(1).join(' ')}">
                        <i class="${iconClass.split(' ')[0]}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">
                            ${notification.title}
                        </p>
                        <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                            ${notification.message}
                        </p>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-xs text-gray-500">
                                ${this.formatTime(notification.created_at)}
                            </span>
                            ${isUnread ? '<span class="text-xs text-blue-600 font-medium">Nueva</span>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Ahora';
        if (minutes < 60) return `${minutes}m`;
        if (hours < 24) return `${hours}h`;
        if (days < 7) return `${days}d`;
        
        return date.toLocaleDateString();
    }
    
    async markAsRead(notificationId) {
        try {
            const response = await fetch(`/api/notifications/${notificationId}/read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            });
            
            if (response.ok) {
                // Actualizar el estado local
                const notification = this.notifications.find(n => n.id == notificationId);
                if (notification && !notification.is_read) {
                    notification.is_read = true;
                    this.unreadCount--;
                    this.updateUI();
                }
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }
    
    async markAllAsRead() {
        try {
            const response = await fetch('/api/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            });
            
            if (response.ok) {
                this.notifications.forEach(n => n.is_read = true);
                this.unreadCount = 0;
                this.updateUI();
            }
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
        }
    }
    
    startPolling() {
        // Verificar nuevas notificaciones cada 30 segundos
        setInterval(() => {
            this.loadNotifications();
        }, 30000);
    }
    
    // Método para añadir notificación en tiempo real
    addNotification(notification) {
        this.notifications.unshift(notification);
        if (!notification.is_read) {
            this.unreadCount++;
        }
        this.updateUI();
        
        // Mostrar notificación toast si está implementado
        this.showToast(notification);
    }
    
    showToast(notification) {
        // Implementar notificación toast si se desea
        console.log('Nueva notificación:', notification.title);
    }
}

// Inicializar el gestor de notificaciones cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.notificationManager === 'undefined') {
        window.notificationManager = new NotificationManager();
    }
});
</script>
